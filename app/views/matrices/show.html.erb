<h2>Matrix: <%= @matrix.name %></h2>

<p><%= link_to '[ edit matrix name ]', edit_matrix_path(@matrix) %></p>

<p>Click on a cell to toggle between the following symbols: "X", "O", "X?", "O?", " "

<% 
	minNumOptions = 2 # Should be >= 2
	numCategories = @matrix.categories.count
%>

<table class="matrix" border="1px solid black" border-collapse="collapse"><%# *** Move to CSS %>


	<%# No categories %>
	<% if numCategories == 0 %> 
		<tr>
			<th>&nbsp;</th>
			<th>&nbsp;</th>
		</tr>
		<tr>
			<th>Add 1st category below ...<%# <a href="">Add 1st category</a> %></th>
		</tr>

	<% else %>
		<% categories = @matrix.categories %>

		<%# Row 0: Column #'s' for cells %>
		<tr>
			<%# Blank top left corner %>
			<th colspan="3" rowspan="3">&nbsp;</th>

			<% cCount = 1 %>
			<%#*** Move below into a fragment %>
			<% categories.drop(1).each do |category| %>
				<% category.options.sort_by { |o| o.created_at }.each do |option| %>
					<th class="c<%= cCount %>">c<%= cCount %></th>
					<% cCount += 1 %>
				<% end %>
				<% if category.options.count < minNumOptions %>
					<% for i in (category.options.count + 1)..minNumOptions %>
						<th class="c<%= cCount %>">c<%= cCount %></th>
						<% cCount += 1 %>
					<% end %>
				<% end %>
			<% end %>			
			<%#*** Move above into a fragment %>
		</tr>

		<%# Row 1: Category 2..N %>
		<tr>			
			<% cCount = 0 %>
			<% categories.drop(1).each do |category| %>
				<% 
					numCols = category.options.count < minNumOptions ? minNumOptions : category.options.count
					classes = (1..numCols).map() { |i| "c" + (cCount += 1).to_s }.join(" ")
				%>
				<th colspan="<%= numCols %>" class="<%= classes %>">
					<%= category.name %> <%# <a href="">[e]</a> %>
				</th>
			<% end %>

			<%# "Add category" %>
			<%# <th rowspan="2"><a href="">Add category</a></th> %><%#*** add colspan? %>
		</tr>
		
		<%# Row 2: Options for categories 2..N %>
		<tr>
			<% cCount = 0 %>
			<% categories.drop(1).each do |category| %>
				<% category.options.sort_by { |o| o.created_at }.each do |option| %>
					<th class="c<%= cCount += 1 %>"><%= option.name %></th>
				<% end %>
				<% if category.options.count < minNumOptions %>
					<% for i in (category.options.count + 1)..minNumOptions %>
						<th class="c<%= cCount += 1 %>">&nbsp;</th>
					<% end %>
				<% end %>
			<% end %>
		</tr>

		<%# Row 3 on: Category 1 & its options, then Category N-1 & its options, etc. %>
		<% 	
			categoriesForRows = [ @matrix.categories.first ].concat(@matrix.categories.drop(2).reverse)
			rCount = 1
		%>		
		<% categoriesForRows.each_with_index do |category, rowGroupIndex| %>
			<%
				options = category.options.sort_by { |o| o.created_at }
				if options.count < 2
					for i in 1..minNumOptions do
						options.push(" ") #*** Use &nbsp;
					end
				end
				categorySpan = options.count
			%>

			<% options.each_with_index do |option, optionIndex| %>
				<tr class="<%= rowGroupIndex.odd? ? 'oddRowGroup' : 'evenRowGroup' %>">
					<%# r# %>
					<th class="r<%= rCount %>">r<%= rCount %></th>

					<%# Category %>
					<% if optionIndex == 0 %>
						<%
							classes = "vertical " + 
								(0..(categorySpan - 1)).map() { |i| "r" + (rCount + i).to_s }.join(" ") 
						%>
						<th class="<%= classes %>" rowspan="<%= categorySpan %>"><%= category.name %></th>
					<% end %>
					
					<%# Option %>
					<th class="vertical r<%= rCount %>"><%= option.is_a?(String) ? option : option.name %></th>

					<%# Playable cells %>
					<% cCount = 1 %>
					<% categories.slice(1, numCategories - 1 - rowGroupIndex)
							.each_with_index do |columnCategory, columnGroupIndex| %>
						<% for i in 1..(columnCategory.options.count < minNumOptions ? minNumOptions : columnCategory.options.count) %>
							<td class="cell r<%= rCount %> c<%=cCount %> <%= columnGroupIndex.odd? ? 'oddColumnGroup' : 'evenColumnGroup' %>"
								id="r<%= rCount %>c<%= cCount %>">
								&nbsp;
							</td>
							<% cCount += 1 %>
						<% end %>
					<% end %>
					<% rCount += 1 %>
				</tr>
			<% end %>
		<% end %>
	<% end %>
</table>

<br/><br/><br/>
<hr/>


<h2>Moves</h2>

<p>Key: [ &lt;CELL_ID&gt; : &lt;SYMBOL&gt; ]</p>

<div id="moves">
	<div>
	<% @matrix.moves.sort_by { |m| m.created_at }.each_with_index do |move, index| %>
	    <span>[ <%= move.cell %> : <%= move.symbol %> ]</span>
	    <% if ((index + 1) % 10) == 0 %>
	    	</div><div>
    	<% end %>
	<% end %>
	</div>
</div>	

<br/><br/>
<hr/>

<% if false %>
<h2>Add a move</h2>

<%= form_for([@matrix, @matrix.moves.build]) do |f| %>
  <p>
    <%= f.label :cell %> <%= f.text_field :cell %>
    <%= f.label :symbol %> <%= f.text_field :symbol %>
    <%= f.submit %>
  </p>
<% end %>

<br/><br/><br/>
<hr/>
<% end %>

<h2>Categories &amp; Options</h2>
<%= render @matrix.categories %>

<br/><br/>
<hr/>


<h2>Add a category</h2>
<%= render 'categories/form' %>

<br/><br/>
<hr/>


[ <%= link_to 'All matrices', matrices_path %> ]
